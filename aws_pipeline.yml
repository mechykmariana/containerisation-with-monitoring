version: 1.0

# Define the source stage for the pipeline (CodeCommit or GitHub)
source:
  provider: GitHub
  repository: containerisation-with-monitoring
  # Add your GitHub repository
  branch: main

# Define the build stage for the pipeline (CodeBuild for Docker build)
build:
  provider: CodeBuild
  project: thesis_pure_aws  # Reference the CodeBuild project name here
  environment:
    type: LINUX_CONTAINER
    image: "aws/codebuild/standard:4.0"
    computeType: BUILD_GENERAL1_SMALL
    environmentVariables:
      DOCKER_USERNAME: $(dockerUsername)  # Define Docker credentials as environment variables in CodeBuild
      DOCKER_PASSWORD: $(dockerPassword)
      BACKEND_IMAGE_NAME: django-backend
      FRONTEND_IMAGE_NAME: react-frontend
      TAG: latest

# Define deployment for backend and frontend images to AWS ECS or EKS
deploy:
  provider: ECS  # You can use ECS or EKS depending on your setup
  clusterName: <your-ecs-cluster-name>
  serviceName: <your-ecs-service-name>
  imageDefinitions:
    backend: '<account-id>.dkr.ecr.<region>.amazonaws.com/django-backend:latest'
    frontend: '<account-id>.dkr.ecr.<region>.amazonaws.com/react-frontend:latest'

# Define the Terraform execution step (optional)
terraform:
  provider: AWS
  script:
    - terraform init
    - terraform plan
    - terraform apply -auto-approve
